---
breadcrumbs: ["Styles", "Examples…"]
title: Parametric perambulation
description: 
font: Amstelvar-Alpha
size: 14
class: compact parambulation
text: >
    I'm afraid I still don't understand, sir.
    A surprise party? Mr. Worf, I hate surprise parties. I would <strong>never</strong> do that to you.
    Sorry, Data. 
    When has justice ever been as simple as a rule book? 
    I'll alert the crew. 
    Earl Grey tea, watercress sandwiches… and Bularian canapés? Are you up for promotion? 
    Commander William Riker of the Starship Enterprise. 
    Yesterday I did not know how to eat gagh. 
    Yes, absolutely, I do indeed concur, wholeheartedly!
element: p
---
<style>
    .parambulation .extra-content ul.paraxes {
        margin: 0;
        padding: 0;
    }

    .parambulation .extra-content ul.paraxes > li {
        margin: 0;
        padding: 0;
    }
    
    .parambulation .extra-content ul.paraxes > li.changed {
        font-weight: bold;
    }
</style>

<ul class='parambuliders'>
    <li><label>Size</label> <input type='range' name='size' min='10' max='48' value='14'><label></label></li>
    <li><label>Weight</label> <input type='range' name='relweight' min='43' max='284' value='100'><label></label></li>
</ul>

<script>
(function() {
    var para = document.querySelector('.parambulation .rendered');
    var extraContent = document.querySelector('.parambulation .extra-content');

    extraContent.parentNode.insertBefore(extraContent, extraContent.parentNode.firstChild);

    //pull axis info from typetools
    var axes = {{site.data.fonts.axes[site.data.fonts.names["Amstelvar-Alpha"]]|jsonify}};
    var defaults = Object.keys(axes).reduce(function(defaults, axis, i) { if ("default" in axes[axis]) { defaults[axis] = axes[axis].default; } return defaults; }, {});
    var composites = {
        "opsz":{
            "10":{"XOPQ":110,"YOPQ":75,"YTLC":525},
            "14":[],
            "72":{"XTRA":300,"YOPQ":12,"YTLC":475}
        },"wdth":{
            "35":{"XTRA":42,"XOPQ":70,"YOPQ":45,"PWDT":60},
            "100":[]
        },"wght":{
            "100":{"XOPQ":38,"YOPQ":25,"XTRA":375,"YTSE":8,"PWGT":38},
            "400":[],
            "900":{"XOPQ":250,"XTRA":250,"YTLC":525,"PWGT":250}
        }
    };

    function compositeToParametric(caxis, cvalue) {
        cvalue = parseFloat(cvalue);
        
        if (!(caxis in composites)) {
            var temp = {};
            temp[caxis] = cvalue;
            return temp;
        }
    
        //maintain a list of all axes mentioned in the composite, so we can reset them all
        var allAxes = {};   
        
        var lowerPivot, upperPivot;
        var lowerAxes, upperAxes;
        //pivot value and axes
        composites[caxis].forEach(function(paxes, pivot) {
            pivot = parseFloat(pivot);
            
            //add any new axes to the list
            paxes.forEach(function(pval, paxis) {
                if (!(paxis in allAxes)) {
                    allAxes[paxis] = axes[paxis].default;
                }
            });
            
            if (pivot >= cvalue) {
                //first time this happens we can stop
                if (isNaN(upperPivot)) {
                    upperPivot = pivot;
                    upperAxes = paxes;
                }
            }
            
            if (isNaN(lowerPivot) || isNaN(upperPivot)) {
                //first runthru OR we still haven't found the top of the range
                lowerPivot = pivot;
                lowerAxes = paxes;
            }
        });
    
        if (isNaN(upperPivot)) {
            upperPivot = lowerPivot;
            upperAxes = lowerAxes;
        }

        var result = {};
        
        allAxes.forEach(function(dflt, axis) {
            var u = axis in upperAxes ? upperAxes[axis] : dflt;
            var l = axis in lowerAxes ? lowerAxes[axis] : dflt;
            var r = upperPivot === lowerPivot ? 0.0 : (cvalue-lowerPivot)/(upperPivot-lowerPivot);
            result[axis] = l + r*(u-l);
            if (axes[axis].max - axes[axis].min > 50) {
                result[axis] = Math.round(result[axis]);
            }
        });

        return result;
    }

    //given a value for a parametric axis, back-calculate the composite value that would produce it
    function parametricToComposite(paxis, pvalue, caxis) {
        if (!(caxis in composites)) {
            return null;
        }
    
        pvalue = parseFloat(pvalue);

        var mydefault = axes[paxis].default;
        
        var lowerC, upperC;
        var lowerP, upperP;

        //pivot value and axes
        composites[caxis].forEach(function(paxes, pivot) {
            pivot = parseFloat(pivot);
            
            var myval = paxis in paxes ? paxes[paxis] : mydefault;

            if (myval >= pvalue) {
                //first time this happens we can stop
                if (isNaN(upperC)) {
                    upperC = pivot;
                    upperP = myval;
                }
            }
            
            if (isNaN(lowerC) || isNaN(upperC)) {
                //first runthru OR we still haven't found the top of the range
                lowerC = pivot;
                lowerP = myval;
            }
        });
    
        if (!upperC) {
            upperC = lowerC;
            upperP = lowerP;
        }

        if (upperC === lowerC) {
            return upperC;
        }

        var result = lowerC + (pvalue - lowerP)/(upperP - lowerP) * (upperC - lowerC);

        if (axes[caxis].max - axes[caxis].min > 50) {
            return Math.round(result);
        }
        
        return result;
    }

    //set up axis listing
    var axesDisplay = document.createElement('ul');
    axesDisplay.className = 'paraxes';
    defaults.forEach(function(d, axis) {
        var li = document.createElement('li');
        li.className = axis;
        li.setAttribute('data-default', d);
        li.innerHTML = "<label>" + axis + "</label> <output>" + d + "</output>";
        axesDisplay.appendChild(li);
    });
    extraContent.appendChild(axesDisplay);
    
    //set everything to default
    para.style.fontSize = '14pt';
    para.style.fontWeight = 'normal';
    para.style.fontVariationSettings = obj2fvs(defaults);
    
    var opszOutput = axesDisplay.querySelector('li.opsz output');
    var wghtOutput = axesDisplay.querySelector('li.wght output');
    
    var sliders = document.querySelector('ul.parambuliders');
    var sizeSlider = sliders.querySelector('input[name=size]');
    var weightSlider = sliders.querySelector('input[name=relweight]');

    function doSizeWeight() {
        var fvs = fvs2obj(para.style.fontVariationSettings);
        var axisDeltas = {};
        var opsz = parseFloat(sizeSlider.value);

        para.style.fontSize = opsz + 'pt';

        //apply opsz deltas
        compositeToParametric('opsz', opsz).forEach(function(v, k) {
            axisDeltas[k] = v - axes[k].default;
        });

        //calculate adjusted weight as % of default XOPQ
        var baseXOPQ = axes.XOPQ.default + (axisDeltas.XOPQ || 0);
        var targetXOPQ = Math.round(baseXOPQ * weightSlider.value/100);

        //back-figure wght value from XOPQ
        var targetWght = parametricToComposite('XOPQ', targetXOPQ, 'wght');
        
        //apply wght deltas
        compositeToParametric('wght', targetWght).forEach(function(v, k) {
            if (!(k in axisDeltas)) {
                axisDeltas[k] = 0;
            }
            axisDeltas[k] += v - axes[k].default;
        });

        axisDeltas.forEach(function(v, k) {
            fvs[k] = axes[k].default + v;
            var output = axesDisplay.querySelector('li.' + k);
            output.querySelector('output').textContent =  v;
            if (v == 0) {
                output.className = k;
            } else {
                output.className = k + " changed";
            }
        });
        
        opszOutput.textContent = fvs.opsz + " (" + sizeSlider.value + ")";
        wghtOutput.textContent = fvs.wght + " (" + weightSlider.value + "%)";
        
        para.style.fontVariationSettings = obj2fvs(fvs);
    }
    
    sliders.addEventListener('input', doSizeWeight);
    sliders.addEventListener('change', doSizeWeight);
})();
</script>